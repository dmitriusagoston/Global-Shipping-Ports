<!DOCTYPE html>
<meta charset="utf-8">
<style>
	.same {
		display: none;
	}
	
    #port-change {
        position: absolute;
        top: 450px;
        left: 10px;
    }
</style>

<!-- Load d3.js and the geo projection plugin -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<html>
	<h1 style = "text-align:center"><bold>Global Shipping Ports</bold></h1>
	
	<button id="port-change" type="button">Switch Port Radius</button>

	<!-- Create an element where the map will take place -->
	<svg id="my_dataviz" width="500" height="400"></svg>
	<p>This visualization shows a world map with various shipping ports as circles. The radius of the circle gets larger as the volume of goods being transferred increases while the color of the circle gets lighter as the political value of the port increases. The volume of goods is being measured in Twenty-foot Equivalent Units (TEUs). There is a correlation between the color and the size of the circles as larger ports hold more political power.</p>
</html>
	
<script>

// The svg
var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

var color = d3.scaleThreshold()
    .domain([0, 1, 3, 5, 10, 15, 20, 30, 40, 45, 50])
    .range(["#0d0887","#41049d","#6a00a8","#8f0da4","#b12a90","#cc4778","#e16462","#f2844b","#fca636","#fcce25","#f0f921"]);
    
// Map and projection
var path = d3.geoPath();
var projection = d3.geoMercator()
  .scale(70)
  .center([0,20])
  .translate([width / 2, (height / 2) + 25]);

d3.queue()
  .defer(d3.json, "world.json")  // World shape
  .defer(d3.csv, "top100port.csv") // Position of circles
  .await(ready);

function ready(error, dataGeo, data) {

var valueExtent = d3.extent(data, function(d) { return +d.size; })

  // Add a scale for bubble size
  var size = d3.scaleSqrt()
    .domain(valueExtent)  // What's in the data
    .range([ 1, 15])  // Size in pixel

  // Draw the map
  svg.append("g")
    .selectAll("path")
    .data(dataGeo.features)
    .enter()
    .append("path")
      // draw each country
      .attr("d", d3.geoPath()
        .projection(projection)
      )
      .attr("fill", "#DDD")
      .attr("stroke", "#999")
      .attr("stroke-width", 0.5)
    
  // Add circles:
  svg.selectAll("myCircles")
    .data(data.sort(function(a,b) { return +b.size - +a.size }).filter(function(d,i){ return i<1000 }))
    .enter()
    .append("circle")
	  .attr("class", "diff")
      .attr("cx", function(d){ return projection([+d.lon, +d.lat])[0] })
      .attr("cy", function(d){ return projection([+d.lon, +d.lat])[1] })
      .attr("r", function(d){ return size(+d.size) })
      .attr("stroke-width", 1)
      .attr("fill", function(d){ return color(+d.size) })
      .attr("fill-opacity", .4)

  svg.selectAll("myCircles")
    .data(data.sort(function(a,b) { return +b.size - +a.size }).filter(function(d,i){ return i<1000 }))
    .enter()
    .append("circle")
	  .attr("class", "same")
      .attr("cx", function(d){ return projection([+d.lon, +d.lat])[0] })
      .attr("cy", function(d){ return projection([+d.lon, +d.lat])[1] })
      .attr("r", function(d){ return size(2) })
      .attr("stroke-width", 0.3)
      .attr("fill", function(d){ return color(+d.size) })
      .attr("fill-opacity", .7)
      .attr("stroke", "#333")
}
	
d3.select("#port-change").on("click", function(){
	const check = document.querySelectorAll(".diff");
	const check2 = document.querySelectorAll(".same");
	if (check[0].style.display == '') {
		for (let i = 0; i < check.length; i++) {
			check[i].style.display = "none";
		}
		for (let i = 0; i < check2.length; i++) {
			check2[i].style.display = "block";
		}
	} else {
		for (let i = 0; i < check.length; i++) {
			check[i].style.display = "";
		}
		for (let i = 0; i < check2.length; i++) {
			check2[i].style.display = "none";
		}
	}
});
    
var x = d3.scaleSqrt()
    .domain([0, 50])
    .rangeRound([240, 490]);

var g = svg.append("g")
    .attr("class", "key")
    .attr("transform", "translate(0,40)");
 

g.selectAll("rect")
  .data(color.range().map(function(d) {
      d = color.invertExtent(d);
      if (d[0] == null) d[0] = x.domain()[0];
      if (d[1] == null) d[1] = x.domain()[1];
      return d;
    }))
  .enter().append("rect")
    .attr("height", 8)
    .attr("x", function(d) { return x(d[0]); })
    .attr("width", function(d) { return x(d[1]) - x(d[0]); })
    .attr("fill", function(d) { return color(d[0]); });

g.append("text")
    .attr("class", "caption")
    .attr("x", x.range()[0])
    .attr("y", -5)
    .attr("fill", "#000")
    .attr("text-anchor", "start")
    .attr("font-weight", "bold")
    .text("Volume Transported (Million TEU)");

g.call(d3.axisBottom(x)
    .tickSize(13)
    .tickValues(color.domain()))
  .select(".domain")
    .remove();
    
</script>